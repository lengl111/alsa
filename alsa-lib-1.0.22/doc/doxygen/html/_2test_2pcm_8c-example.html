<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>ALSA project - the C library reference: /test/pcm.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">ALSA project - the C library reference
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">/test/pcm.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> *  This small demo sends a simple sinusoidal wave to your speakers.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sched.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;../include/asoundlib.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/time.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;math.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> *device = <span class="stringliteral">&quot;plughw:0,0&quot;</span>;         <span class="comment">/* playback device */</span></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="group___p_c_m.html#gaa14b7f26877a812acbb39811364177f8">snd_pcm_format_t</a> format = <a name="a0"></a><a class="code" href="group___p_c_m.html#ggaa14b7f26877a812acbb39811364177f8aac4470b6be81c22af0cfe528bee4a474">SND_PCM_FORMAT_S16</a>;    <span class="comment">/* sample format */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rate = 44100;           <span class="comment">/* stream rate */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> channels = 1;           <span class="comment">/* count of channels */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> buffer_time = 500000;       <span class="comment">/* ring buffer length in us */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> period_time = 100000;       <span class="comment">/* period time in us */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">double</span> freq = 440;               <span class="comment">/* sinusoidal wave frequency in Hz */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> verbose = 0;                 <span class="comment">/* verbose flag */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> resample = 1;                <span class="comment">/* enable alsa-lib resampling */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> period_event = 0;                <span class="comment">/* produce poll event after each period */</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="group___p_c_m.html#ga71cdfa37e258d2210b8bd0216bf0c36c">snd_pcm_sframes_t</a> buffer_size;</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="group___p_c_m.html#ga71cdfa37e258d2210b8bd0216bf0c36c">snd_pcm_sframes_t</a> period_size;</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="group___output.html#ga49729cc6454539495c1f5b6e95cd474a">snd_output_t</a> *output = NULL;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> generate_sine(<span class="keyword">const</span> <a name="_a1"></a><a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas, </div>
<div class="line">              <a class="code" href="group___p_c_m.html#gab01fcfe9b97382a8d3f2027c664b8b8a">snd_pcm_uframes_t</a> offset,</div>
<div class="line">              <span class="keywordtype">int</span> count, <span class="keywordtype">double</span> *_phase)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">double</span> max_phase = 2. * M_PI;</div>
<div class="line">    <span class="keywordtype">double</span> phase = *_phase;</div>
<div class="line">    <span class="keywordtype">double</span> step = max_phase*freq/(double)rate;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *samples[channels];</div>
<div class="line">    <span class="keywordtype">int</span> steps[channels];</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> chn;</div>
<div class="line">    <span class="keywordtype">int</span> format_bits = <a name="a2"></a><a class="code" href="group___p_c_m___helpers.html#ga8d4e07f2d68cc16f607857ed8a222a29">snd_pcm_format_width</a>(format);</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxval = (1 &lt;&lt; (format_bits - 1)) - 1;</div>
<div class="line">    <span class="keywordtype">int</span> bps = format_bits / 8;  <span class="comment">/* bytes per sample */</span></div>
<div class="line">    <span class="keywordtype">int</span> phys_bps = <a name="a3"></a><a class="code" href="group___p_c_m___helpers.html#gaa3e0ff7560342e5af2b5c7bd2d63a307">snd_pcm_format_physical_width</a>(format) / 8;</div>
<div class="line">    <span class="keywordtype">int</span> big_endian = <a name="a4"></a><a class="code" href="group___p_c_m___helpers.html#ga3c0c224b8f67e73cf2447bee0110f760">snd_pcm_format_big_endian</a>(format) == 1;</div>
<div class="line">    <span class="keywordtype">int</span> to_unsigned = <a name="a5"></a><a class="code" href="group___p_c_m___helpers.html#ga8cd4e3ecc963942457e3b1b6f7661a90">snd_pcm_format_unsigned</a>(format) == 1;</div>
<div class="line">    <span class="keywordtype">int</span> is_float = (format == <a name="a6"></a><a class="code" href="group___p_c_m.html#ggaa14b7f26877a812acbb39811364177f8a083f32474a84d344e0da496470085c8f">SND_PCM_FORMAT_FLOAT_LE</a> ||</div>
<div class="line">            format == <a name="a7"></a><a class="code" href="group___p_c_m.html#ggaa14b7f26877a812acbb39811364177f8ab24eac408b0d2ae6b5f68ed3a7cd2d75">SND_PCM_FORMAT_FLOAT_BE</a>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* verify and prepare the contents of areas */</span></div>
<div class="line">    <span class="keywordflow">for</span> (chn = 0; chn &lt; channels; chn++) {</div>
<div class="line">        <span class="keywordflow">if</span> ((areas[chn].first % 8) != 0) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;areas[%i].first == %i, aborting...\n&quot;</span>, chn, areas[chn].first);</div>
<div class="line">            exit(EXIT_FAILURE);</div>
<div class="line">        }</div>
<div class="line">        samples[chn] = <span class="comment">/*(signed short *)*/</span>(((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)areas[chn].addr) + (areas[chn].<a name="a8"></a><a class="code" href="structsnd__pcm__channel__area__t.html#aba2a69e0d221beaa9f2f115254cb515a">first</a> / 8));</div>
<div class="line">        <span class="keywordflow">if</span> ((areas[chn].step % 16) != 0) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;areas[%i].step == %i, aborting...\n&quot;</span>, chn, areas[chn].step);</div>
<div class="line">            exit(EXIT_FAILURE);</div>
<div class="line">        }</div>
<div class="line">        steps[chn] = areas[chn].<a name="a9"></a><a class="code" href="structsnd__pcm__channel__area__t.html#aedbe57a917a0ba24bf1f526387e6e43a">step</a> / 8;</div>
<div class="line">        samples[chn] += offset * steps[chn];</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* fill the channel areas */</span></div>
<div class="line">    <span class="keywordflow">while</span> (count-- &gt; 0) {</div>
<div class="line">        <span class="keyword">union </span>{</div>
<div class="line">            <span class="keywordtype">float</span> f;</div>
<div class="line">            <span class="keywordtype">int</span> i;</div>
<div class="line">        } fval;</div>
<div class="line">        <span class="keywordtype">int</span> res, i;</div>
<div class="line">        <span class="keywordflow">if</span> (is_float) {</div>
<div class="line">            fval.f = sin(phase) * maxval;</div>
<div class="line">            res = fval.i;</div>
<div class="line">        } <span class="keywordflow">else</span></div>
<div class="line">            res = sin(phase) * maxval;</div>
<div class="line">        <span class="keywordflow">if</span> (to_unsigned)</div>
<div class="line">            res ^= 1U &lt;&lt; (format_bits - 1);</div>
<div class="line">        <span class="keywordflow">for</span> (chn = 0; chn &lt; channels; chn++) {</div>
<div class="line">            <span class="comment">/* Generate data in native endian format */</span></div>
<div class="line">            <span class="keywordflow">if</span> (big_endian) {</div>
<div class="line">                <span class="keywordflow">for</span> (i = 0; i &lt; bps; i++)</div>
<div class="line">                    *(samples[chn] + phys_bps - 1 - i) = (res &gt;&gt; i * 8) &amp; 0xff;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                <span class="keywordflow">for</span> (i = 0; i &lt; bps; i++)</div>
<div class="line">                    *(samples[chn] + i) = (res &gt;&gt;  i * 8) &amp; 0xff;</div>
<div class="line">            }</div>
<div class="line">            samples[chn] += steps[chn];</div>
<div class="line">        }</div>
<div class="line">        phase += step;</div>
<div class="line">        <span class="keywordflow">if</span> (phase &gt;= max_phase)</div>
<div class="line">            phase -= max_phase;</div>
<div class="line">    }</div>
<div class="line">    *_phase = phase;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> set_hwparams(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle,</div>
<div class="line">            <a class="code" href="group___p_c_m.html#ga65c737127994f0a980edad744e36dc40">snd_pcm_hw_params_t</a> *params,</div>
<div class="line">            <a class="code" href="group___p_c_m.html#ga661221ba5e8f1d6eaf4ab8e2da57cc1a">snd_pcm_access_t</a> access)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rrate;</div>
<div class="line">    <a class="code" href="group___p_c_m.html#gab01fcfe9b97382a8d3f2027c664b8b8a">snd_pcm_uframes_t</a> size;</div>
<div class="line">    <span class="keywordtype">int</span> err, dir;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* choose all parameters */</span></div>
<div class="line">    err = <a name="a10"></a><a class="code" href="group___p_c_m___h_w___params.html#ga6e2dd8efbb7a4084bd05e6cc458d84f7">snd_pcm_hw_params_any</a>(handle, params);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Broken configuration for playback: no configurations available: %s\n&quot;</span>, <a name="a11"></a><a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        <span class="keywordflow">return</span> err;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* set hardware resampling */</span></div>
<div class="line">    err = <a name="a12"></a><a class="code" href="group___p_c_m___h_w___params.html#ga82eecc0e27a94ce0caa195cc3765536c">snd_pcm_hw_params_set_rate_resample</a>(handle, params, resample);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Resampling setup failed for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        <span class="keywordflow">return</span> err;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* set the interleaved read/write format */</span></div>
<div class="line">    err = <a name="a13"></a><a class="code" href="group___p_c_m___h_w___params.html#ga4c8f1c632931923531ca68ee048a8de8">snd_pcm_hw_params_set_access</a>(handle, params, access);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Access type not available for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        <span class="keywordflow">return</span> err;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* set the sample format */</span></div>
<div class="line">    err = <a name="a14"></a><a class="code" href="group___p_c_m___h_w___params.html#ga6014e0e1ec7934f8c745290e83e59199">snd_pcm_hw_params_set_format</a>(handle, params, format);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Sample format not available for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        <span class="keywordflow">return</span> err;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* set the count of channels */</span></div>
<div class="line">    err = <a name="a15"></a><a class="code" href="group___p_c_m___h_w___params.html#ga3a5b2a05c5d9869cc743dac71c0d270a">snd_pcm_hw_params_set_channels</a>(handle, params, channels);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Channels count (%i) not available for playbacks: %s\n&quot;</span>, channels, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        <span class="keywordflow">return</span> err;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* set the stream rate */</span></div>
<div class="line">    rrate = rate;</div>
<div class="line">    err = <a name="a16"></a><a class="code" href="group___p_c_m___h_w___params.html#ga39124280d06ce63092a77e3f25ddd6ee">snd_pcm_hw_params_set_rate_near</a>(handle, params, &amp;rrate, 0);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Rate %iHz not available for playback: %s\n&quot;</span>, rate, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        <span class="keywordflow">return</span> err;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (rrate != rate) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Rate doesn&#39;t match (requested %iHz, get %iHz)\n&quot;</span>, rate, err);</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* set the buffer time */</span></div>
<div class="line">    err = <a name="a17"></a><a class="code" href="group___p_c_m___h_w___params.html#ga3bc1b188576d6d2daae9c56024813d10">snd_pcm_hw_params_set_buffer_time_near</a>(handle, params, &amp;buffer_time, &amp;dir);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Unable to set buffer time %i for playback: %s\n&quot;</span>, buffer_time, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        <span class="keywordflow">return</span> err;</div>
<div class="line">    }</div>
<div class="line">    err = <a name="a18"></a><a class="code" href="group___p_c_m___h_w___params.html#gab6556fcaaf926360d2064044a6f6cfb4">snd_pcm_hw_params_get_buffer_size</a>(params, &amp;size);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Unable to get buffer size for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        <span class="keywordflow">return</span> err;</div>
<div class="line">    }</div>
<div class="line">    buffer_size = size;</div>
<div class="line">    <span class="comment">/* set the period time */</span></div>
<div class="line">    err = <a name="a19"></a><a class="code" href="group___p_c_m___h_w___params.html#gaa22d4f917c300b0c1f47b348c23705a4">snd_pcm_hw_params_set_period_time_near</a>(handle, params, &amp;period_time, &amp;dir);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Unable to set period time %i for playback: %s\n&quot;</span>, period_time, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        <span class="keywordflow">return</span> err;</div>
<div class="line">    }</div>
<div class="line">    err = <a name="a20"></a><a class="code" href="group___p_c_m___h_w___params.html#gaba48ea189171536f9793e0d99e6db5e0">snd_pcm_hw_params_get_period_size</a>(params, &amp;size, &amp;dir);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Unable to get period size for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        <span class="keywordflow">return</span> err;</div>
<div class="line">    }</div>
<div class="line">    period_size = size;</div>
<div class="line">    <span class="comment">/* write the parameters to device */</span></div>
<div class="line">    err = <a name="a21"></a><a class="code" href="group___p_c_m.html#ga1ca0dc120a484965e26cabf966502330">snd_pcm_hw_params</a>(handle, params);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Unable to set hw params for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        <span class="keywordflow">return</span> err;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> set_swparams(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle, <a class="code" href="group___p_c_m.html#ga7e082d9ea701709270b0674a0be23b09">snd_pcm_sw_params_t</a> *swparams)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> err;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* get the current swparams */</span></div>
<div class="line">    err = <a name="a22"></a><a class="code" href="group___p_c_m.html#ga61c5495ffb44c75aaa595e85512d28de">snd_pcm_sw_params_current</a>(handle, swparams);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Unable to determine current swparams for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        <span class="keywordflow">return</span> err;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* start the transfer when the buffer is almost full: */</span></div>
<div class="line">    <span class="comment">/* (buffer_size / avail_min) * avail_min */</span></div>
<div class="line">    err = <a name="a23"></a><a class="code" href="group___p_c_m___s_w___params.html#ga1d338f1f7e33b7a6d0f9a8f61f87f057">snd_pcm_sw_params_set_start_threshold</a>(handle, swparams, (buffer_size / period_size) * period_size);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Unable to set start threshold mode for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        <span class="keywordflow">return</span> err;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* allow the transfer when at least period_size samples can be processed */</span></div>
<div class="line">    <span class="comment">/* or disable this mechanism when period event is enabled (aka interrupt like style processing) */</span></div>
<div class="line">    err = <a name="a24"></a><a class="code" href="group___p_c_m___s_w___params.html#ga79b12cbbd309750156261e7f5a39167b">snd_pcm_sw_params_set_avail_min</a>(handle, swparams, period_event ? buffer_size : period_size);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Unable to set avail min for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        <span class="keywordflow">return</span> err;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* enable period events when requested */</span></div>
<div class="line">    <span class="keywordflow">if</span> (period_event) {</div>
<div class="line">        err = <a name="a25"></a><a class="code" href="group___p_c_m___s_w___params.html#gaf62ce50d6242b4f4dc9d6534a97e5c09">snd_pcm_sw_params_set_period_event</a>(handle, swparams, 1);</div>
<div class="line">        <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Unable to set period event: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">            <span class="keywordflow">return</span> err;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* write the parameters to the playback device */</span></div>
<div class="line">    err = <a name="a26"></a><a class="code" href="group___p_c_m.html#ga891ccaeea2c685a533b61b5fa0493974">snd_pcm_sw_params</a>(handle, swparams);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Unable to set sw params for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        <span class="keywordflow">return</span> err;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> *   Underrun and suspend recovery</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> xrun_recovery(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle, <span class="keywordtype">int</span> err)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (verbose)</div>
<div class="line">        printf(<span class="stringliteral">&quot;stream recovery\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (err == -EPIPE) {    <span class="comment">/* under-run */</span></div>
<div class="line">        err = <a name="a27"></a><a class="code" href="group___p_c_m.html#ga788d05de75f2d536f8443cb0306754d0">snd_pcm_prepare</a>(handle);</div>
<div class="line">        <span class="keywordflow">if</span> (err &lt; 0)</div>
<div class="line">            printf(<span class="stringliteral">&quot;Can&#39;t recovery from underrun, prepare failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == -ESTRPIPE) {</div>
<div class="line">        <span class="keywordflow">while</span> ((err = <a name="a28"></a><a class="code" href="group___p_c_m.html#ga13083ce2209aab9ea73831610bc61ab1">snd_pcm_resume</a>(handle)) == -EAGAIN)</div>
<div class="line">            sleep(1);   <span class="comment">/* wait until the suspend flag is released */</span></div>
<div class="line">        <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">            err = <a class="code" href="group___p_c_m.html#ga788d05de75f2d536f8443cb0306754d0">snd_pcm_prepare</a>(handle);</div>
<div class="line">            <span class="keywordflow">if</span> (err &lt; 0)</div>
<div class="line">                printf(<span class="stringliteral">&quot;Can&#39;t recovery from suspend, prepare failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> err;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> *   Transfer method - write only</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> write_loop(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle,</div>
<div class="line">              <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *samples,</div>
<div class="line">              <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">double</span> phase = 0;</div>
<div class="line">    <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *<a name="a29"></a><a class="code" href="seq__event_8h.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>;</div>
<div class="line">    <span class="keywordtype">int</span> err, cptr;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line">        generate_sine(areas, 0, period_size, &amp;phase);</div>
<div class="line">        ptr = samples;</div>
<div class="line">        cptr = period_size;</div>
<div class="line">        <span class="keywordflow">while</span> (cptr &gt; 0) {</div>
<div class="line">            err = <a name="a30"></a><a class="code" href="group___p_c_m.html#gabc748a500743713eafa960c7d104ca6f">snd_pcm_writei</a>(handle, ptr, cptr);</div>
<div class="line">            <span class="keywordflow">if</span> (err == -EAGAIN)</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">                <span class="keywordflow">if</span> (xrun_recovery(handle, err) &lt; 0) {</div>
<div class="line">                    printf(<span class="stringliteral">&quot;Write error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">                    exit(EXIT_FAILURE);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">break</span>;  <span class="comment">/* skip one period */</span></div>
<div class="line">            }</div>
<div class="line">            ptr += err * channels;</div>
<div class="line">            cptr -= err;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> *   Transfer method - write and wait for room in buffer using poll</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> wait_for_poll(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle, <span class="keyword">struct</span> pollfd *ufds, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> revents;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line">        poll(ufds, count, -1);</div>
<div class="line">        <a name="a31"></a><a class="code" href="group___p_c_m.html#ga7e561f305702c6f52dab49b6c84f7df7">snd_pcm_poll_descriptors_revents</a>(handle, ufds, count, &amp;revents);</div>
<div class="line">        <span class="keywordflow">if</span> (revents &amp; POLLERR)</div>
<div class="line">            <span class="keywordflow">return</span> -EIO;</div>
<div class="line">        <span class="keywordflow">if</span> (revents &amp; POLLOUT)</div>
<div class="line">            <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> write_and_poll_loop(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle,</div>
<div class="line">                   <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *samples,</div>
<div class="line">                   <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>pollfd *ufds;</div>
<div class="line">    <span class="keywordtype">double</span> phase = 0;</div>
<div class="line">    <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *<a class="code" href="seq__event_8h.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>;</div>
<div class="line">    <span class="keywordtype">int</span> err, count, cptr, init;</div>
<div class="line"></div>
<div class="line">    count = <a name="a32"></a><a class="code" href="group___p_c_m.html#gac7f4cdb1c930b8d343714f60afa02fc4">snd_pcm_poll_descriptors_count</a> (handle);</div>
<div class="line">    <span class="keywordflow">if</span> (count &lt;= 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Invalid poll descriptors count\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> count;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    ufds = malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> pollfd) * count);</div>
<div class="line">    <span class="keywordflow">if</span> (ufds == NULL) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;No enough memory\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> ((err = <a name="a33"></a><a class="code" href="group___p_c_m.html#ga742e8705f6992fd0e36efc868e574f01">snd_pcm_poll_descriptors</a>(handle, ufds, count)) &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Unable to obtain poll descriptors for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        <span class="keywordflow">return</span> err;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    init = 1;</div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line">        <span class="keywordflow">if</span> (!init) {</div>
<div class="line">            err = wait_for_poll(handle, ufds, count);</div>
<div class="line">            <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">                <span class="keywordflow">if</span> (<a name="a34"></a><a class="code" href="group___p_c_m.html#ga87896f6f17020fc19835790369e7ce75">snd_pcm_state</a>(handle) == <a name="a35"></a><a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860ab63b5b90201110cd586b686355fd5d83">SND_PCM_STATE_XRUN</a> ||</div>
<div class="line">                    <a class="code" href="group___p_c_m.html#ga87896f6f17020fc19835790369e7ce75">snd_pcm_state</a>(handle) == <a name="a36"></a><a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860a79a05b6b619f88e153d50d9daf2e84bf">SND_PCM_STATE_SUSPENDED</a>) {</div>
<div class="line">                    err = <a class="code" href="group___p_c_m.html#ga87896f6f17020fc19835790369e7ce75">snd_pcm_state</a>(handle) == <a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860ab63b5b90201110cd586b686355fd5d83">SND_PCM_STATE_XRUN</a> ? -EPIPE : -ESTRPIPE;</div>
<div class="line">                    <span class="keywordflow">if</span> (xrun_recovery(handle, err) &lt; 0) {</div>
<div class="line">                        printf(<span class="stringliteral">&quot;Write error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">                        exit(EXIT_FAILURE);</div>
<div class="line">                    }</div>
<div class="line">                    init = 1;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    printf(<span class="stringliteral">&quot;Wait for poll failed\n&quot;</span>);</div>
<div class="line">                    <span class="keywordflow">return</span> err;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        generate_sine(areas, 0, period_size, &amp;phase);</div>
<div class="line">        ptr = samples;</div>
<div class="line">        cptr = period_size;</div>
<div class="line">        <span class="keywordflow">while</span> (cptr &gt; 0) {</div>
<div class="line">            err = <a class="code" href="group___p_c_m.html#gabc748a500743713eafa960c7d104ca6f">snd_pcm_writei</a>(handle, ptr, cptr);</div>
<div class="line">            <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">                <span class="keywordflow">if</span> (xrun_recovery(handle, err) &lt; 0) {</div>
<div class="line">                    printf(<span class="stringliteral">&quot;Write error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">                    exit(EXIT_FAILURE);</div>
<div class="line">                }</div>
<div class="line">                init = 1;</div>
<div class="line">                <span class="keywordflow">break</span>;  <span class="comment">/* skip one period */</span></div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="group___p_c_m.html#ga87896f6f17020fc19835790369e7ce75">snd_pcm_state</a>(handle) == <a name="a37"></a><a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860a86f6fbc796881f19fde0e1957f878147">SND_PCM_STATE_RUNNING</a>)</div>
<div class="line">                init = 0;</div>
<div class="line">            ptr += err * channels;</div>
<div class="line">            cptr -= err;</div>
<div class="line">            <span class="keywordflow">if</span> (cptr == 0)</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="comment">/* it is possible, that the initial buffer cannot store */</span></div>
<div class="line">            <span class="comment">/* all data from the last period, so wait awhile */</span></div>
<div class="line">            err = wait_for_poll(handle, ufds, count);</div>
<div class="line">            <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">                <span class="keywordflow">if</span> (<a class="code" href="group___p_c_m.html#ga87896f6f17020fc19835790369e7ce75">snd_pcm_state</a>(handle) == <a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860ab63b5b90201110cd586b686355fd5d83">SND_PCM_STATE_XRUN</a> ||</div>
<div class="line">                    <a class="code" href="group___p_c_m.html#ga87896f6f17020fc19835790369e7ce75">snd_pcm_state</a>(handle) == <a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860a79a05b6b619f88e153d50d9daf2e84bf">SND_PCM_STATE_SUSPENDED</a>) {</div>
<div class="line">                    err = <a class="code" href="group___p_c_m.html#ga87896f6f17020fc19835790369e7ce75">snd_pcm_state</a>(handle) == <a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860ab63b5b90201110cd586b686355fd5d83">SND_PCM_STATE_XRUN</a> ? -EPIPE : -ESTRPIPE;</div>
<div class="line">                    <span class="keywordflow">if</span> (xrun_recovery(handle, err) &lt; 0) {</div>
<div class="line">                        printf(<span class="stringliteral">&quot;Write error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">                        exit(EXIT_FAILURE);</div>
<div class="line">                    }</div>
<div class="line">                    init = 1;</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    printf(<span class="stringliteral">&quot;Wait for poll failed\n&quot;</span>);</div>
<div class="line">                    <span class="keywordflow">return</span> err;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> *   Transfer method - asynchronous notification</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>async_private_data {</div>
<div class="line">    <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *samples;</div>
<div class="line">    <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas;</div>
<div class="line">    <span class="keywordtype">double</span> phase;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> async_callback(<a class="code" href="group___global.html#ga8cd9a1d441e9219ca5f2ff04094c7c6d">snd_async_handler_t</a> *ahandler)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle = <a name="a38"></a><a class="code" href="group___p_c_m.html#gace4920d5943820c395dab8d9cd4fed0a">snd_async_handler_get_pcm</a>(ahandler);</div>
<div class="line">    <span class="keyword">struct </span>async_private_data *data = <a name="a39"></a><a class="code" href="group___global.html#gad9c76588a87918901c6273e6bc98a1bc">snd_async_handler_get_callback_private</a>(ahandler);</div>
<div class="line">    <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *samples = data-&gt;samples;</div>
<div class="line">    <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas = data-&gt;areas;</div>
<div class="line">    <a class="code" href="group___p_c_m.html#ga71cdfa37e258d2210b8bd0216bf0c36c">snd_pcm_sframes_t</a> avail;</div>
<div class="line">    <span class="keywordtype">int</span> err;</div>
<div class="line">    </div>
<div class="line">    avail = <a name="a40"></a><a class="code" href="group___p_c_m.html#ga8bb836bd0c414b59789d51a5f5379c08">snd_pcm_avail_update</a>(handle);</div>
<div class="line">    <span class="keywordflow">while</span> (avail &gt;= period_size) {</div>
<div class="line">        generate_sine(areas, 0, period_size, &amp;data-&gt;phase);</div>
<div class="line">        err = <a class="code" href="group___p_c_m.html#gabc748a500743713eafa960c7d104ca6f">snd_pcm_writei</a>(handle, samples, period_size);</div>
<div class="line">        <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Write error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">            exit(EXIT_FAILURE);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (err != period_size) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Write error: written %i expected %li\n&quot;</span>, err, period_size);</div>
<div class="line">            exit(EXIT_FAILURE);</div>
<div class="line">        }</div>
<div class="line">        avail = <a class="code" href="group___p_c_m.html#ga8bb836bd0c414b59789d51a5f5379c08">snd_pcm_avail_update</a>(handle);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> async_loop(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle,</div>
<div class="line">              <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *samples,</div>
<div class="line">              <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>async_private_data data;</div>
<div class="line">    <a class="code" href="group___global.html#ga8cd9a1d441e9219ca5f2ff04094c7c6d">snd_async_handler_t</a> *ahandler;</div>
<div class="line">    <span class="keywordtype">int</span> err, count;</div>
<div class="line"></div>
<div class="line">    data.samples = samples;</div>
<div class="line">    data.areas = areas;</div>
<div class="line">    data.phase = 0;</div>
<div class="line">    err = <a name="a41"></a><a class="code" href="group___p_c_m.html#ga5a0c0da6d0d35a3ac9f6a97567ac3b63">snd_async_add_pcm_handler</a>(&amp;ahandler, handle, async_callback, &amp;data);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Unable to register async handler\n&quot;</span>);</div>
<div class="line">        exit(EXIT_FAILURE);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (count = 0; count &lt; 2; count++) {</div>
<div class="line">        generate_sine(areas, 0, period_size, &amp;data.phase);</div>
<div class="line">        err = <a class="code" href="group___p_c_m.html#gabc748a500743713eafa960c7d104ca6f">snd_pcm_writei</a>(handle, samples, period_size);</div>
<div class="line">        <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Initial write error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">            exit(EXIT_FAILURE);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (err != period_size) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Initial write error: written %i expected %li\n&quot;</span>, err, period_size);</div>
<div class="line">            exit(EXIT_FAILURE);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___p_c_m.html#ga87896f6f17020fc19835790369e7ce75">snd_pcm_state</a>(handle) == <a name="a42"></a><a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860a3eb4a3b75c7d2adb22f1829f3f738b27">SND_PCM_STATE_PREPARED</a>) {</div>
<div class="line">        err = <a name="a43"></a><a class="code" href="group___p_c_m.html#ga6bdb88b68a9d9e66015d770f600c6aea">snd_pcm_start</a>(handle);</div>
<div class="line">        <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">            printf(<span class="stringliteral">&quot;Start error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">            exit(EXIT_FAILURE);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* because all other work is done in the signal handler,</span></div>
<div class="line"><span class="comment">       suspend the process */</span></div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line">        sleep(1);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> *   Transfer method - asynchronous notification + direct write</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> async_direct_callback(<a class="code" href="group___global.html#ga8cd9a1d441e9219ca5f2ff04094c7c6d">snd_async_handler_t</a> *ahandler)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle = <a class="code" href="group___p_c_m.html#gace4920d5943820c395dab8d9cd4fed0a">snd_async_handler_get_pcm</a>(ahandler);</div>
<div class="line">    <span class="keyword">struct </span>async_private_data *data = <a class="code" href="group___global.html#gad9c76588a87918901c6273e6bc98a1bc">snd_async_handler_get_callback_private</a>(ahandler);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *my_areas;</div>
<div class="line">    <a class="code" href="group___p_c_m.html#gab01fcfe9b97382a8d3f2027c664b8b8a">snd_pcm_uframes_t</a> offset, frames, size;</div>
<div class="line">    <a class="code" href="group___p_c_m.html#ga71cdfa37e258d2210b8bd0216bf0c36c">snd_pcm_sframes_t</a> avail, commitres;</div>
<div class="line">    <a class="code" href="group___p_c_m.html#ga61ac499cb3701ce536d4d83725908860">snd_pcm_state_t</a> state;</div>
<div class="line">    <span class="keywordtype">int</span> first = 0, err;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line">        state = <a class="code" href="group___p_c_m.html#ga87896f6f17020fc19835790369e7ce75">snd_pcm_state</a>(handle);</div>
<div class="line">        <span class="keywordflow">if</span> (state == <a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860ab63b5b90201110cd586b686355fd5d83">SND_PCM_STATE_XRUN</a>) {</div>
<div class="line">            err = xrun_recovery(handle, -EPIPE);</div>
<div class="line">            <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">                printf(<span class="stringliteral">&quot;XRUN recovery failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">                exit(EXIT_FAILURE);</div>
<div class="line">            }</div>
<div class="line">            first = 1;</div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state == <a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860a79a05b6b619f88e153d50d9daf2e84bf">SND_PCM_STATE_SUSPENDED</a>) {</div>
<div class="line">            err = xrun_recovery(handle, -ESTRPIPE);</div>
<div class="line">            <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">                printf(<span class="stringliteral">&quot;SUSPEND recovery failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">                exit(EXIT_FAILURE);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        avail = <a class="code" href="group___p_c_m.html#ga8bb836bd0c414b59789d51a5f5379c08">snd_pcm_avail_update</a>(handle);</div>
<div class="line">        <span class="keywordflow">if</span> (avail &lt; 0) {</div>
<div class="line">            err = xrun_recovery(handle, avail);</div>
<div class="line">            <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">                printf(<span class="stringliteral">&quot;avail update failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">                exit(EXIT_FAILURE);</div>
<div class="line">            }</div>
<div class="line">            first = 1;</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (avail &lt; period_size) {</div>
<div class="line">            <span class="keywordflow">if</span> (first) {</div>
<div class="line">                first = 0;</div>
<div class="line">                err = <a class="code" href="group___p_c_m.html#ga6bdb88b68a9d9e66015d770f600c6aea">snd_pcm_start</a>(handle);</div>
<div class="line">                <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">                    printf(<span class="stringliteral">&quot;Start error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">                    exit(EXIT_FAILURE);</div>
<div class="line">                }</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        size = period_size;</div>
<div class="line">        <span class="keywordflow">while</span> (size &gt; 0) {</div>
<div class="line">            frames = size;</div>
<div class="line">            err = <a name="a44"></a><a class="code" href="group___p_c_m___direct.html#ga6d4acf42de554d4d1177fb035d484ea4">snd_pcm_mmap_begin</a>(handle, &amp;my_areas, &amp;offset, &amp;frames);</div>
<div class="line">            <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">                <span class="keywordflow">if</span> ((err = xrun_recovery(handle, err)) &lt; 0) {</div>
<div class="line">                    printf(<span class="stringliteral">&quot;MMAP begin avail error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">                    exit(EXIT_FAILURE);</div>
<div class="line">                }</div>
<div class="line">                first = 1;</div>
<div class="line">            }</div>
<div class="line">            generate_sine(my_areas, offset, frames, &amp;data-&gt;phase);</div>
<div class="line">            commitres = <a name="a45"></a><a class="code" href="group___p_c_m___direct.html#gac306bd13c305825aa39dd9180a3ad520">snd_pcm_mmap_commit</a>(handle, offset, frames);</div>
<div class="line">            <span class="keywordflow">if</span> (commitres &lt; 0 || (<a class="code" href="group___p_c_m.html#gab01fcfe9b97382a8d3f2027c664b8b8a">snd_pcm_uframes_t</a>)commitres != frames) {</div>
<div class="line">                <span class="keywordflow">if</span> ((err = xrun_recovery(handle, commitres &gt;= 0 ? -EPIPE : commitres)) &lt; 0) {</div>
<div class="line">                    printf(<span class="stringliteral">&quot;MMAP commit error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">                    exit(EXIT_FAILURE);</div>
<div class="line">                }</div>
<div class="line">                first = 1;</div>
<div class="line">            }</div>
<div class="line">            size -= frames;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> async_direct_loop(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle,</div>
<div class="line">                 <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *samples ATTRIBUTE_UNUSED,</div>
<div class="line">                 <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas ATTRIBUTE_UNUSED)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>async_private_data data;</div>
<div class="line">    <a class="code" href="group___global.html#ga8cd9a1d441e9219ca5f2ff04094c7c6d">snd_async_handler_t</a> *ahandler;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *my_areas;</div>
<div class="line">    <a class="code" href="group___p_c_m.html#gab01fcfe9b97382a8d3f2027c664b8b8a">snd_pcm_uframes_t</a> offset, frames, size;</div>
<div class="line">    <a class="code" href="group___p_c_m.html#ga71cdfa37e258d2210b8bd0216bf0c36c">snd_pcm_sframes_t</a> commitres;</div>
<div class="line">    <span class="keywordtype">int</span> err, count;</div>
<div class="line"></div>
<div class="line">    data.samples = NULL;    <span class="comment">/* we do not require the global sample area for direct write */</span></div>
<div class="line">    data.areas = NULL;  <span class="comment">/* we do not require the global areas for direct write */</span></div>
<div class="line">    data.phase = 0;</div>
<div class="line">    err = <a class="code" href="group___p_c_m.html#ga5a0c0da6d0d35a3ac9f6a97567ac3b63">snd_async_add_pcm_handler</a>(&amp;ahandler, handle, async_direct_callback, &amp;data);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Unable to register async handler\n&quot;</span>);</div>
<div class="line">        exit(EXIT_FAILURE);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (count = 0; count &lt; 2; count++) {</div>
<div class="line">        size = period_size;</div>
<div class="line">        <span class="keywordflow">while</span> (size &gt; 0) {</div>
<div class="line">            frames = size;</div>
<div class="line">            err = <a class="code" href="group___p_c_m___direct.html#ga6d4acf42de554d4d1177fb035d484ea4">snd_pcm_mmap_begin</a>(handle, &amp;my_areas, &amp;offset, &amp;frames);</div>
<div class="line">            <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">                <span class="keywordflow">if</span> ((err = xrun_recovery(handle, err)) &lt; 0) {</div>
<div class="line">                    printf(<span class="stringliteral">&quot;MMAP begin avail error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">                    exit(EXIT_FAILURE);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            generate_sine(my_areas, offset, frames, &amp;data.phase);</div>
<div class="line">            commitres = <a class="code" href="group___p_c_m___direct.html#gac306bd13c305825aa39dd9180a3ad520">snd_pcm_mmap_commit</a>(handle, offset, frames);</div>
<div class="line">            <span class="keywordflow">if</span> (commitres &lt; 0 || (<a class="code" href="group___p_c_m.html#gab01fcfe9b97382a8d3f2027c664b8b8a">snd_pcm_uframes_t</a>)commitres != frames) {</div>
<div class="line">                <span class="keywordflow">if</span> ((err = xrun_recovery(handle, commitres &gt;= 0 ? -EPIPE : commitres)) &lt; 0) {</div>
<div class="line">                    printf(<span class="stringliteral">&quot;MMAP commit error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">                    exit(EXIT_FAILURE);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            size -= frames;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    err = <a class="code" href="group___p_c_m.html#ga6bdb88b68a9d9e66015d770f600c6aea">snd_pcm_start</a>(handle);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Start error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        exit(EXIT_FAILURE);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* because all other work is done in the signal handler,</span></div>
<div class="line"><span class="comment">       suspend the process */</span></div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line">        sleep(1);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> *   Transfer method - direct write only</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> direct_loop(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle,</div>
<div class="line">               <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *samples ATTRIBUTE_UNUSED,</div>
<div class="line">               <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas ATTRIBUTE_UNUSED)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">double</span> phase = 0;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *my_areas;</div>
<div class="line">    <a class="code" href="group___p_c_m.html#gab01fcfe9b97382a8d3f2027c664b8b8a">snd_pcm_uframes_t</a> offset, frames, size;</div>
<div class="line">    <a class="code" href="group___p_c_m.html#ga71cdfa37e258d2210b8bd0216bf0c36c">snd_pcm_sframes_t</a> avail, commitres;</div>
<div class="line">    <a class="code" href="group___p_c_m.html#ga61ac499cb3701ce536d4d83725908860">snd_pcm_state_t</a> state;</div>
<div class="line">    <span class="keywordtype">int</span> err, first = 1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line">        state = <a class="code" href="group___p_c_m.html#ga87896f6f17020fc19835790369e7ce75">snd_pcm_state</a>(handle);</div>
<div class="line">        <span class="keywordflow">if</span> (state == <a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860ab63b5b90201110cd586b686355fd5d83">SND_PCM_STATE_XRUN</a>) {</div>
<div class="line">            err = xrun_recovery(handle, -EPIPE);</div>
<div class="line">            <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">                printf(<span class="stringliteral">&quot;XRUN recovery failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">                <span class="keywordflow">return</span> err;</div>
<div class="line">            }</div>
<div class="line">            first = 1;</div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state == <a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860a79a05b6b619f88e153d50d9daf2e84bf">SND_PCM_STATE_SUSPENDED</a>) {</div>
<div class="line">            err = xrun_recovery(handle, -ESTRPIPE);</div>
<div class="line">            <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">                printf(<span class="stringliteral">&quot;SUSPEND recovery failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">                <span class="keywordflow">return</span> err;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        avail = <a class="code" href="group___p_c_m.html#ga8bb836bd0c414b59789d51a5f5379c08">snd_pcm_avail_update</a>(handle);</div>
<div class="line">        <span class="keywordflow">if</span> (avail &lt; 0) {</div>
<div class="line">            err = xrun_recovery(handle, avail);</div>
<div class="line">            <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">                printf(<span class="stringliteral">&quot;avail update failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">                <span class="keywordflow">return</span> err;</div>
<div class="line">            }</div>
<div class="line">            first = 1;</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (avail &lt; period_size) {</div>
<div class="line">            <span class="keywordflow">if</span> (first) {</div>
<div class="line">                first = 0;</div>
<div class="line">                err = <a class="code" href="group___p_c_m.html#ga6bdb88b68a9d9e66015d770f600c6aea">snd_pcm_start</a>(handle);</div>
<div class="line">                <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">                    printf(<span class="stringliteral">&quot;Start error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">                    exit(EXIT_FAILURE);</div>
<div class="line">                }</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                err = <a name="a46"></a><a class="code" href="group___p_c_m.html#gad4d53d58b996a7cd9a5cbf1710b90375">snd_pcm_wait</a>(handle, -1);</div>
<div class="line">                <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">                    <span class="keywordflow">if</span> ((err = xrun_recovery(handle, err)) &lt; 0) {</div>
<div class="line">                        printf(<span class="stringliteral">&quot;snd_pcm_wait error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">                        exit(EXIT_FAILURE);</div>
<div class="line">                    }</div>
<div class="line">                    first = 1;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        size = period_size;</div>
<div class="line">        <span class="keywordflow">while</span> (size &gt; 0) {</div>
<div class="line">            frames = size;</div>
<div class="line">            err = <a class="code" href="group___p_c_m___direct.html#ga6d4acf42de554d4d1177fb035d484ea4">snd_pcm_mmap_begin</a>(handle, &amp;my_areas, &amp;offset, &amp;frames);</div>
<div class="line">            <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">                <span class="keywordflow">if</span> ((err = xrun_recovery(handle, err)) &lt; 0) {</div>
<div class="line">                    printf(<span class="stringliteral">&quot;MMAP begin avail error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">                    exit(EXIT_FAILURE);</div>
<div class="line">                }</div>
<div class="line">                first = 1;</div>
<div class="line">            }</div>
<div class="line">            generate_sine(my_areas, offset, frames, &amp;phase);</div>
<div class="line">            commitres = <a class="code" href="group___p_c_m___direct.html#gac306bd13c305825aa39dd9180a3ad520">snd_pcm_mmap_commit</a>(handle, offset, frames);</div>
<div class="line">            <span class="keywordflow">if</span> (commitres &lt; 0 || (<a class="code" href="group___p_c_m.html#gab01fcfe9b97382a8d3f2027c664b8b8a">snd_pcm_uframes_t</a>)commitres != frames) {</div>
<div class="line">                <span class="keywordflow">if</span> ((err = xrun_recovery(handle, commitres &gt;= 0 ? -EPIPE : commitres)) &lt; 0) {</div>
<div class="line">                    printf(<span class="stringliteral">&quot;MMAP commit error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">                    exit(EXIT_FAILURE);</div>
<div class="line">                }</div>
<div class="line">                first = 1;</div>
<div class="line">            }</div>
<div class="line">            size -= frames;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> *   Transfer method - direct write only using mmap_write functions</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> direct_write_loop(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle,</div>
<div class="line">                 <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *samples,</div>
<div class="line">                 <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">double</span> phase = 0;</div>
<div class="line">    <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *<a class="code" href="seq__event_8h.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>;</div>
<div class="line">    <span class="keywordtype">int</span> err, cptr;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line">        generate_sine(areas, 0, period_size, &amp;phase);</div>
<div class="line">        ptr = samples;</div>
<div class="line">        cptr = period_size;</div>
<div class="line">        <span class="keywordflow">while</span> (cptr &gt; 0) {</div>
<div class="line">            err = <a name="a47"></a><a class="code" href="group___p_c_m___direct.html#ga5a9ee8e1e764b12da6d54dfa195f7c52">snd_pcm_mmap_writei</a>(handle, ptr, cptr);</div>
<div class="line">            <span class="keywordflow">if</span> (err == -EAGAIN)</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">                <span class="keywordflow">if</span> (xrun_recovery(handle, err) &lt; 0) {</div>
<div class="line">                    printf(<span class="stringliteral">&quot;Write error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">                    exit(EXIT_FAILURE);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">break</span>;  <span class="comment">/* skip one period */</span></div>
<div class="line">            }</div>
<div class="line">            ptr += err * channels;</div>
<div class="line">            cptr -= err;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>transfer_method {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *name;</div>
<div class="line">    <a class="code" href="group___p_c_m.html#ga661221ba5e8f1d6eaf4ab8e2da57cc1a">snd_pcm_access_t</a> access;</div>
<div class="line">    int (*transfer_loop)(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle,</div>
<div class="line">                 <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *samples,</div>
<div class="line">                 <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas);</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>transfer_method transfer_methods[] = {</div>
<div class="line">    { <span class="stringliteral">&quot;write&quot;</span>, <a name="a48"></a><a class="code" href="group___p_c_m.html#gga661221ba5e8f1d6eaf4ab8e2da57cc1aa72a970ed6e676ab0fd9f3c3d36737e0a">SND_PCM_ACCESS_RW_INTERLEAVED</a>, write_loop },</div>
<div class="line">    { <span class="stringliteral">&quot;write_and_poll&quot;</span>, <a class="code" href="group___p_c_m.html#gga661221ba5e8f1d6eaf4ab8e2da57cc1aa72a970ed6e676ab0fd9f3c3d36737e0a">SND_PCM_ACCESS_RW_INTERLEAVED</a>, write_and_poll_loop },</div>
<div class="line">    { <span class="stringliteral">&quot;async&quot;</span>, <a class="code" href="group___p_c_m.html#gga661221ba5e8f1d6eaf4ab8e2da57cc1aa72a970ed6e676ab0fd9f3c3d36737e0a">SND_PCM_ACCESS_RW_INTERLEAVED</a>, async_loop },</div>
<div class="line">    { <span class="stringliteral">&quot;async_direct&quot;</span>, <a name="a49"></a><a class="code" href="group___p_c_m.html#gga661221ba5e8f1d6eaf4ab8e2da57cc1aa90a5dea527c5ae9a53f1448beb2dee6f">SND_PCM_ACCESS_MMAP_INTERLEAVED</a>, async_direct_loop },</div>
<div class="line">    { <span class="stringliteral">&quot;direct_interleaved&quot;</span>, <a class="code" href="group___p_c_m.html#gga661221ba5e8f1d6eaf4ab8e2da57cc1aa90a5dea527c5ae9a53f1448beb2dee6f">SND_PCM_ACCESS_MMAP_INTERLEAVED</a>, direct_loop },</div>
<div class="line">    { <span class="stringliteral">&quot;direct_noninterleaved&quot;</span>, <a name="a50"></a><a class="code" href="group___p_c_m.html#gga661221ba5e8f1d6eaf4ab8e2da57cc1aa7de225785e05dd1d538203c5ece9036e">SND_PCM_ACCESS_MMAP_NONINTERLEAVED</a>, direct_loop },</div>
<div class="line">    { <span class="stringliteral">&quot;direct_write&quot;</span>, <a class="code" href="group___p_c_m.html#gga661221ba5e8f1d6eaf4ab8e2da57cc1aa90a5dea527c5ae9a53f1448beb2dee6f">SND_PCM_ACCESS_MMAP_INTERLEAVED</a>, direct_write_loop },</div>
<div class="line">    { NULL, <a class="code" href="group___p_c_m.html#gga661221ba5e8f1d6eaf4ab8e2da57cc1aa72a970ed6e676ab0fd9f3c3d36737e0a">SND_PCM_ACCESS_RW_INTERLEAVED</a>, NULL }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> help(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> k;</div>
<div class="line">    printf(</div>
<div class="line"><span class="stringliteral">&quot;Usage: pcm [OPTION]... [FILE]...\n&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;-h,--help  help\n&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;-D,--device    playback device\n&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;-r,--rate  stream rate in Hz\n&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;-c,--channels  count of channels in stream\n&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;-f,--frequency sine wave frequency in Hz\n&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;-b,--buffer    ring buffer size in us\n&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;-p,--period    period size in us\n&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;-m,--method    transfer method\n&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;-o,--format    sample format\n&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;-v,--verbose   show the PCM setup parameters\n&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;-n,--noresample  do not resample\n&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;-e,--pevent    enable poll event after each period\n&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;Recognized sample formats are:&quot;</span>);</div>
<div class="line">        <span class="keywordflow">for</span> (k = 0; k &lt; SND_PCM_FORMAT_LAST; ++k) {</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">char</span> *s = <a name="a51"></a><a class="code" href="group___p_c_m___description.html#ga2ca258b8ac569ca35f283e48d2181e45">snd_pcm_format_name</a>(k);</div>
<div class="line">                <span class="keywordflow">if</span> (s)</div>
<div class="line">                        printf(<span class="stringliteral">&quot; %s&quot;</span>, s);</div>
<div class="line">        }</div>
<div class="line">        printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">        printf(<span class="stringliteral">&quot;Recognized transfer methods are:&quot;</span>);</div>
<div class="line">        <span class="keywordflow">for</span> (k = 0; transfer_methods[k].name; k++)</div>
<div class="line">            printf(<span class="stringliteral">&quot; %s&quot;</span>, transfer_methods[k].name);</div>
<div class="line">    printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>option long_option[] =</div>
<div class="line">    {</div>
<div class="line">        {<span class="stringliteral">&quot;help&quot;</span>, 0, NULL, <span class="charliteral">&#39;h&#39;</span>},</div>
<div class="line">        {<span class="stringliteral">&quot;device&quot;</span>, 1, NULL, <span class="charliteral">&#39;D&#39;</span>},</div>
<div class="line">        {<span class="stringliteral">&quot;rate&quot;</span>, 1, NULL, <span class="charliteral">&#39;r&#39;</span>},</div>
<div class="line">        {<span class="stringliteral">&quot;channels&quot;</span>, 1, NULL, <span class="charliteral">&#39;c&#39;</span>},</div>
<div class="line">        {<span class="stringliteral">&quot;frequency&quot;</span>, 1, NULL, <span class="charliteral">&#39;f&#39;</span>},</div>
<div class="line">        {<span class="stringliteral">&quot;buffer&quot;</span>, 1, NULL, <span class="charliteral">&#39;b&#39;</span>},</div>
<div class="line">        {<span class="stringliteral">&quot;period&quot;</span>, 1, NULL, <span class="charliteral">&#39;p&#39;</span>},</div>
<div class="line">        {<span class="stringliteral">&quot;method&quot;</span>, 1, NULL, <span class="charliteral">&#39;m&#39;</span>},</div>
<div class="line">        {<span class="stringliteral">&quot;format&quot;</span>, 1, NULL, <span class="charliteral">&#39;o&#39;</span>},</div>
<div class="line">        {<span class="stringliteral">&quot;verbose&quot;</span>, 1, NULL, <span class="charliteral">&#39;v&#39;</span>},</div>
<div class="line">        {<span class="stringliteral">&quot;noresample&quot;</span>, 1, NULL, <span class="charliteral">&#39;n&#39;</span>},</div>
<div class="line">        {<span class="stringliteral">&quot;pevent&quot;</span>, 1, NULL, <span class="charliteral">&#39;e&#39;</span>},</div>
<div class="line">        {NULL, 0, NULL, 0},</div>
<div class="line">    };</div>
<div class="line">    <a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle;</div>
<div class="line">    <span class="keywordtype">int</span> err, morehelp;</div>
<div class="line">    <a class="code" href="group___p_c_m.html#ga65c737127994f0a980edad744e36dc40">snd_pcm_hw_params_t</a> *hwparams;</div>
<div class="line">    <a class="code" href="group___p_c_m.html#ga7e082d9ea701709270b0674a0be23b09">snd_pcm_sw_params_t</a> *swparams;</div>
<div class="line">    <span class="keywordtype">int</span> method = 0;</div>
<div class="line">    <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *samples;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> chn;</div>
<div class="line">    <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas;</div>
<div class="line"></div>
<div class="line">    <a name="a52"></a><a class="code" href="group___p_c_m___h_w___params.html#ga06b83cb9a788f99b7b09b570b4355cee">snd_pcm_hw_params_alloca</a>(&amp;hwparams);</div>
<div class="line">    <a name="a53"></a><a class="code" href="group___p_c_m___s_w___params.html#ga8e564553bdc89948c918729e3cc7beb0">snd_pcm_sw_params_alloca</a>(&amp;swparams);</div>
<div class="line"></div>
<div class="line">    morehelp = 0;</div>
<div class="line">    <span class="keywordflow">while</span> (1) {</div>
<div class="line">        <span class="keywordtype">int</span> c;</div>
<div class="line">        <span class="keywordflow">if</span> ((c = getopt_long(argc, argv, <span class="stringliteral">&quot;hD:r:c:f:b:p:m:o:vne&quot;</span>, long_option, NULL)) &lt; 0)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">switch</span> (c) {</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;h&#39;</span>:</div>
<div class="line">            morehelp++;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;D&#39;</span>:</div>
<div class="line">            device = strdup(optarg);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;r&#39;</span>:</div>
<div class="line">            rate = atoi(optarg);</div>
<div class="line">            rate = rate &lt; 4000 ? 4000 : rate;</div>
<div class="line">            rate = rate &gt; 196000 ? 196000 : rate;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;c&#39;</span>:</div>
<div class="line">            channels = atoi(optarg);</div>
<div class="line">            channels = channels &lt; 1 ? 1 : channels;</div>
<div class="line">            channels = channels &gt; 1024 ? 1024 : channels;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;f&#39;</span>:</div>
<div class="line">            freq = atoi(optarg);</div>
<div class="line">            freq = freq &lt; 50 ? 50 : freq;</div>
<div class="line">            freq = freq &gt; 5000 ? 5000 : freq;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;b&#39;</span>:</div>
<div class="line">            buffer_time = atoi(optarg);</div>
<div class="line">            buffer_time = buffer_time &lt; 1000 ? 1000 : buffer_time;</div>
<div class="line">            buffer_time = buffer_time &gt; 1000000 ? 1000000 : buffer_time;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:</div>
<div class="line">            period_time = atoi(optarg);</div>
<div class="line">            period_time = period_time &lt; 1000 ? 1000 : period_time;</div>
<div class="line">            period_time = period_time &gt; 1000000 ? 1000000 : period_time;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;m&#39;</span>:</div>
<div class="line">            <span class="keywordflow">for</span> (method = 0; transfer_methods[method].name; method++)</div>
<div class="line">                    <span class="keywordflow">if</span> (!strcasecmp(transfer_methods[method].name, optarg))</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">if</span> (transfer_methods[method].name == NULL)</div>
<div class="line">                method = 0;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;o&#39;</span>:</div>
<div class="line">            <span class="keywordflow">for</span> (format = 0; format &lt; SND_PCM_FORMAT_LAST; format++) {</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">char</span> *format_name = <a class="code" href="group___p_c_m___description.html#ga2ca258b8ac569ca35f283e48d2181e45">snd_pcm_format_name</a>(format);</div>
<div class="line">                <span class="keywordflow">if</span> (format_name)</div>
<div class="line">                    <span class="keywordflow">if</span> (!strcasecmp(format_name, optarg))</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (format == SND_PCM_FORMAT_LAST)</div>
<div class="line">                format = <a class="code" href="group___p_c_m.html#ggaa14b7f26877a812acbb39811364177f8aac4470b6be81c22af0cfe528bee4a474">SND_PCM_FORMAT_S16</a>;</div>
<div class="line">            <span class="keywordflow">if</span> (!<a name="a54"></a><a class="code" href="group___p_c_m___helpers.html#ga5a52bb63323f463198dea3f3c6aca571">snd_pcm_format_linear</a>(format) &amp;&amp;</div>
<div class="line">                !(format == <a class="code" href="group___p_c_m.html#ggaa14b7f26877a812acbb39811364177f8a083f32474a84d344e0da496470085c8f">SND_PCM_FORMAT_FLOAT_LE</a> ||</div>
<div class="line">                  format == <a class="code" href="group___p_c_m.html#ggaa14b7f26877a812acbb39811364177f8ab24eac408b0d2ae6b5f68ed3a7cd2d75">SND_PCM_FORMAT_FLOAT_BE</a>)) {</div>
<div class="line">                printf(<span class="stringliteral">&quot;Invalid (non-linear/float) format %s\n&quot;</span>,</div>
<div class="line">                       optarg);</div>
<div class="line">                <span class="keywordflow">return</span> 1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;v&#39;</span>:</div>
<div class="line">            verbose = 1;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;n&#39;</span>:</div>
<div class="line">            resample = 0;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;e&#39;</span>:</div>
<div class="line">            period_event = 1;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (morehelp) {</div>
<div class="line">        help();</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    err = <a name="a55"></a><a class="code" href="group___output.html#gaca78d01bf6d081274650794861373c7d">snd_output_stdio_attach</a>(&amp;output, stdout, 0);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Output failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;Playback device is %s\n&quot;</span>, device);</div>
<div class="line">    printf(<span class="stringliteral">&quot;Stream parameters are %iHz, %s, %i channels\n&quot;</span>, rate, <a class="code" href="group___p_c_m___description.html#ga2ca258b8ac569ca35f283e48d2181e45">snd_pcm_format_name</a>(format), channels);</div>
<div class="line">    printf(<span class="stringliteral">&quot;Sine wave rate is %.4fHz\n&quot;</span>, freq);</div>
<div class="line">    printf(<span class="stringliteral">&quot;Using transfer method: %s\n&quot;</span>, transfer_methods[method].name);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ((err = <a name="a56"></a><a class="code" href="group___p_c_m.html#ga8340c7dc0ac37f37afe5e7c21d6c528b">snd_pcm_open</a>(&amp;handle, device, <a name="a57"></a><a class="code" href="group___p_c_m.html#ggac23b43ff55add78638e503b9cc892c24a57a2b920dbc34173479fc9036cfc78a1">SND_PCM_STREAM_PLAYBACK</a>, 0)) &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Playback open error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> ((err = set_hwparams(handle, hwparams, transfer_methods[method].access)) &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Setting of hwparams failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        exit(EXIT_FAILURE);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> ((err = set_swparams(handle, swparams)) &lt; 0) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Setting of swparams failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line">        exit(EXIT_FAILURE);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (verbose &gt; 0)</div>
<div class="line">        <a name="a58"></a><a class="code" href="group___p_c_m___dump.html#ga9c5c879409c504e155e234905d031d8d">snd_pcm_dump</a>(handle, output);</div>
<div class="line"></div>
<div class="line">    samples = malloc((period_size * channels * <a class="code" href="group___p_c_m___helpers.html#gaa3e0ff7560342e5af2b5c7bd2d63a307">snd_pcm_format_physical_width</a>(format)) / 8);</div>
<div class="line">    <span class="keywordflow">if</span> (samples == NULL) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;No enough memory\n&quot;</span>);</div>
<div class="line">        exit(EXIT_FAILURE);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    areas = calloc(channels, <span class="keyword">sizeof</span>(<a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a>));</div>
<div class="line">    <span class="keywordflow">if</span> (areas == NULL) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;No enough memory\n&quot;</span>);</div>
<div class="line">        exit(EXIT_FAILURE);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (chn = 0; chn &lt; channels; chn++) {</div>
<div class="line">        areas[chn].<a name="a59"></a><a class="code" href="structsnd__pcm__channel__area__t.html#a83acdf3245dcb74dffe74cce53d65876">addr</a> = samples;</div>
<div class="line">        areas[chn].<a class="code" href="structsnd__pcm__channel__area__t.html#aba2a69e0d221beaa9f2f115254cb515a">first</a> = chn * <a class="code" href="group___p_c_m___helpers.html#gaa3e0ff7560342e5af2b5c7bd2d63a307">snd_pcm_format_physical_width</a>(format);</div>
<div class="line">        areas[chn].<a class="code" href="structsnd__pcm__channel__area__t.html#aedbe57a917a0ba24bf1f526387e6e43a">step</a> = channels * <a class="code" href="group___p_c_m___helpers.html#gaa3e0ff7560342e5af2b5c7bd2d63a307">snd_pcm_format_physical_width</a>(format);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    err = transfer_methods[method].transfer_loop(handle, samples, areas);</div>
<div class="line">    <span class="keywordflow">if</span> (err &lt; 0)</div>
<div class="line">        printf(<span class="stringliteral">&quot;Transfer failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e">snd_strerror</a>(err));</div>
<div class="line"></div>
<div class="line">    free(areas);</div>
<div class="line">    free(samples);</div>
<div class="line">    <a name="a60"></a><a class="code" href="group___p_c_m.html#ga042aba7262a4cbb4d444b6fc08cb7124">snd_pcm_close</a>(handle);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Nov 30 2018 14:22:53 for ALSA project - the C library reference by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
